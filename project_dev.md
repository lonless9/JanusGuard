# JanusGuard 项目编程执行路径

## 项目结构

```
jvm_agent/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── janusguard/
│   │   │           ├── agent/              # Agent 主体模块
│   │   │           │   ├── JanusAgent.java # Agent 入口类 (premain/agentmain)
│   │   │           │   ├── AgentConfig.java # Agent 配置类
│   │   │           │   └── AgentManager.java # Agent 生命周期管理
│   │   │           ├── transformer/        # 字节码转换模块
│   │   │           │   ├── ClassTransformer.java # 主转换器
│   │   │           │   ├── matcher/        # 类和方法匹配器
│   │   │           │   └── interceptor/    # 具体拦截器实现
│   │   │           ├── core/              # 核心功能模块
│   │   │           │   ├── event/         # 事件定义和处理
│   │   │           │   ├── monitor/       # 监控点实现
│   │   │           │   ├── rule/          # 规则引擎
│   │   │           │   └── context/       # 上下文管理
│   │   │           ├── transport/         # 数据传输模块
│   │   │           │   ├── queue/         # 内部队列实现
│   │   │           │   ├── reporter/      # 数据上报
│   │   │           │   └── connector/     # 与控制中心连接
│   │   │           ├── config/            # 配置管理模块
│   │   │           │   ├── loader/        # 配置加载器
│   │   │           │   ├── model/         # 配置数据模型
│   │   │           │   └── dynamic/       # 动态配置管理
│   │   │           └── common/            # 公共工具类
│   │   │               ├── util/          # 通用工具
│   │   │               ├── constants/     # 常量定义
│   │   │               └── logging/       # 日志工具
│   │   └── resources/
│   │       ├── META-INF/
│   │       │   └── MANIFEST.MF            # Agent Manifest
│   │       └── janusguard-default.yaml    # 默认配置文件
│   └── test/
│       └── java/                          # 单元测试
├── examples/                              # 示例应用
├── docs/                                  # 文档
└── build.gradle/pom.xml                   # 构建文件
```

## 开发阶段规划

### 阶段一：核心框架与基础监控（1-4周）

#### 1.1 项目初始化与基础设施搭建（1周）

1. **[x] 创建项目骨架**
   - [x] 建立 Maven/Gradle 项目，定义依赖和插件
   - [x] 设置 Agent Manifest 配置
   - [x] 创建基础包结构

2. **[x] 核心 Agent 类实现**
   - [x] 实现 `JanusAgent` 类，包含 `premain` 和 `agentmain` 方法
   - [x] 实现基础配置加载 `AgentConfig`
   - [x] 设置简单日志系统

3. **[x] 基础字节码转换框架**
   - [x] 集成 Byte Buddy
   - [x] 实现基础 `ClassTransformer`
   - [x] 创建简单的类匹配器和方法匹配器

#### 1.2 基础监控点实现（2周）

1. **[x] 敏感方法调用监控**
   - [x] 监控 `Runtime.exec` 和 `ProcessBuilder.start`
   - [x] 监控反射调用 `Method.invoke`
   - [x] 监控基础文件操作 `FileInputStream/FileOutputStream`

2. **[x] 事件模型与处理**
   - [x] 定义事件数据结构
   - [x] 实现简单事件记录器
   - [x] 创建本地日志文件记录机制

3. **[x] 开发测试用例**
   - [x] 创建简单的被监控应用
   - [x] 实现监控测试

#### 1.3 初步完善与优化（1周）

1. **[x] 完善配置系统**
   - [x] 实现 YAML/JSON 配置文件支持
   - [x] 添加基础配置项验证

2. **[x] Agent 生命周期管理**
   - [x] 实现优雅启动和关闭
   - [x] 添加基础错误处理机制

3. **[x] 初步集成测试**
   - [x] 在各种简单场景下测试 Agent
   - [x] 发现并修复初期问题

### 阶段二：增强监控与性能优化（4-8周）

#### 2.1 增强监控点（2周）

1. **[ ] 网络相关监控**
   - [ ] 监控 `Socket`、`ServerSocket` 操作
   - [ ] 监控 HTTP 客户端调用
   - [ ] 收集连接信息、目标地址等

2. **[ ] 动态类加载监控**
   - [ ] 监控 `ClassLoader.defineClass` 和 `loadClass`
   - [ ] 监控 `URLClassLoader` 相关操作
   - [ ] 记录类名、来源信息

3. **[ ] SQL 执行监控**
   - [ ] 监控 JDBC 相关操作
   - [ ] 记录 SQL 语句（脱敏处理）

#### 2.2 性能优化（2周）

1. **[x] 引入高性能队列**
   - [x] 集成 LMAX Disruptor
   - [x] 实现事件异步处理

2. **[ ] 优化字节码转换**
   - [ ] 实现转换缓存
   - [ ] 添加精细化类过滤
   - [ ] 优化探针代码生成

3. **[ ] 采样机制**
   - [ ] 实现基本采样策略
   - [ ] 针对高频事件设置采样率

#### 2.3 数据上报与存储（1周）

1. **[ ] 实现数据批量上报**
   - [ ] 支持 HTTP/gRPC 上报
   - [ ] 添加数据压缩
   - [ ] 实现重试机制

2. **[x] 简单本地存储**
   - [x] 实现环形缓冲区
   - [x] 支持持久化关键事件

#### 2.4 基础规则引擎（1-2周）

1. **[ ] 规则 DSL v1 设计与实现**
   - [ ] 定义基础规则语法
   - [ ] 实现规则解析器
   - [ ] 创建规则匹配引擎

2. **[ ] 集成规则与监控**
   - [ ] 将规则应用于监控点
   - [ ] 实现基于规则的事件过滤与分类

3. **[ ] 规则管理**
   - [ ] 加载预定义规则
   - [ ] 保存规则执行状态

### 阶段三：智能化与动态性（8-12周）

#### 3.1 与控制中心通信（2周）

1. **[ ] 双向通信通道**
   - [ ] 实现与控制中心的安全连接
   - [ ] 支持 TLS 加密
   - [ ] 实现心跳与自检机制

2. **[ ] 命令处理**
   - [ ] 接收并执行控制命令
   - [ ] 支持动态开关监控点
   - [ ] 实现远程诊断能力

#### 3.2 动态配置更新（2周）

1. **[ ] 配置热更新**
   - [ ] 实现配置动态加载
   - [ ] 支持部分配置热更新
   - [ ] 确保更新不影响运行中监控

2. **[ ] 监控策略动态调整**
   - [ ] 根据指令调整监控范围
   - [ ] 动态修改采样率
   - [ ] 支持添加/移除监控目标

#### 3.3 本地关联引擎（2-3周）

1. **[ ] 轻量级关联分析**
   - [ ] 在 Agent 本地关联相关事件
   - [ ] 实现时间窗口内事件聚合
   - [ ] 识别简单攻击模式

2. **[ ] 上下文管理**
   - [ ] 维护调用上下文信息
   - [ ] 关联 HTTP 请求与后续操作
   - [ ] 跟踪线程级调用链

#### 3.4 高级规则与策略（2周）

1. **[ ] 规则 DSL v2**
   - [ ] 增强规则表达能力
   - [ ] 支持组合条件和复杂逻辑
   - [ ] 添加时间维度规则

2. **[ ] 自适应调整**
   - [ ] 基于事件频率调整监控
   - [ ] 实现动态阈值计算
   - [ ] 支持基于反馈的规则调优

### 阶段四：高级特性与生态集成（12周+）

#### 4.1 高级安全分析特性（3-4周）

1. **[ ] 污点追踪原型**
   - [ ] 实现基础污点标记
   - [ ] 追踪关键数据流动
   - [ ] 识别外部输入到敏感操作的路径

2. **[ ] 字节码动态分析**
   - [ ] 分析动态加载的类
   - [ ] 识别恶意代码特征
   - [ ] 集成威胁模式库

#### 4.2 与后端分析平台集成（2-3周）

1. **[ ] 标准化数据格式**
   - [ ] 实现通用事件格式
   - [ ] 支持多种后端系统
   - [ ] 添加丰富的元数据

2. **[ ] 基线分析支持**
   - [ ] 接收并应用行为基线
   - [ ] 调整告警与监控策略
   - [ ] 支持异常模式检测

#### 4.3 扩展兼容性与健壮性（2-3周）

1. **[ ] 多 JDK 版本兼容**
   - [ ] 测试并适配 JDK 8-17
   - [ ] 处理不同版本字节码差异
   - [ ] 兼容各种 ClassLoader 实现

2. **[ ] 框架适配**
   - [ ] 测试主流 Java 框架兼容性
   - [ ] 针对特定框架优化监控点
   - [ ] 解决与其他 Agent 冲突问题

3. **[ ] 异常与故障处理**
   - [ ] 完善错误恢复机制
   - [ ] 实现自我保护模式
   - [ ] 增强故障诊断能力

#### 4.4 文档与工具（2周）

1. **[ ] 全面文档**
   - [ ] API 文档
   - [ ] 用户手册
   - [ ] 配置和规则参考

2. **[ ] 辅助工具**
   - [ ] Agent 附加工具
   - [ ] 规则生成器
   - [ ] 测试与验证工具

## 关键类设计

### 1. JanusAgent 类

```java
package com.janusguard.agent;

import java.lang.instrument.Instrumentation;

public class JanusAgent {
    // Agent 入口点 - 启动时加载
    public static void premain(String args, Instrumentation inst) {
        // 初始化配置
        // 设置转换器
        // 启动事件处理
        // 建立控制通道
    }
    
    // Agent 入口点 - 运行时附加
    public static void agentmain(String args, Instrumentation inst) {
        // 类似 premain，但可能有不同的初始化逻辑
    }
}
```

### 2. ClassTransformer 类

```java
package com.janusguard.transformer;

import java.lang.instrument.ClassFileTransformer;
import net.bytebuddy.agent.builder.AgentBuilder;

public class ClassTransformer implements ClassFileTransformer {
    // 使用 ByteBuddy 实现类转换
    // 根据配置选择监控点
    // 管理转换缓存
}
```

### 3. EventProcessor 类

```java
package com.janusguard.core.event;

public class EventProcessor {
    // 处理从探针收集的事件
    // 应用规则引擎
    // 将事件放入队列
    // 可能进行本地关联分析
}
```

### 4. DataReporter 类

```java
package com.janusguard.transport.reporter;

public class DataReporter {
    // 从队列获取事件
    // 批量处理
    // 压缩数据
    // 上报到控制中心
}
```

## 技术选型

1. **字节码操作**: Byte Buddy (主要), ASM (在需要极致性能的场景)
2. **配置格式**: YAML, JSON
3. **内部队列**: LMAX Disruptor
4. **序列化**: Protocol Buffers, Jackson
5. **通信协议**: gRPC, WebSocket
6. **日志**: SLF4J + Logback
7. **测试**: JUnit, Mockito

## 关键技术挑战与解决方案

1. **性能影响最小化**
   - 轻量级探针设计
   - 异步处理机制
   - 精确类/方法匹配
   - 采样策略

2. **动态性与自适应**
   - 热配置更新
   - 基于事件频率的调整
   - 反馈循环机制

3. **兼容性**
   - 充分测试不同 JDK 版本
   - 特殊处理核心类库
   - 隔离 Agent 自身代码

4. **安全性**
   - 数据脱敏
   - 安全通信
   - 防止 Agent 自身被攻击

## 测试策略

1. **单元测试**
   - 覆盖关键组件
   - 模拟各种场景

2. **集成测试**
   - 测试完整功能链路
   - 与控制中心交互

3. **性能测试**
   - 测量性能影响
   - 压力测试

4. **兼容性测试**
   - 不同 JDK 版本
   - 不同 Java 框架
   - 各种应用场景

## 里程碑

1. **[x] 里程碑 1**: 基础 Agent 框架 + 简单监控点 (4周)
2. **[ ] 里程碑 2**: 完整监控点 + 高性能队列 + 基础上报 (8周)
3. **[ ] 里程碑 3**: 双向通信 + 动态配置 + 本地关联 (12周)
4. **[ ] 里程碑 4**: 高级特性 + 后端集成 + 全面测试 (16周+)

## 风险与缓解

1. **性能风险**
   - 风险: Agent 导致严重性能下降
   - 缓解: 早期性能测试、采样机制、精细化控制

2. **兼容性风险**
   - 风险: 与特定 JVM/框架不兼容
   - 缓解: 广泛测试、兼容性模式、优雅降级

3. **安全风险**
   - 风险: Agent 自身成为攻击目标
   - 缓解: 代码安全审计、最小权限原则、防篡改机制

4. **复杂度风险**
   - 风险: 项目过于复杂难以维护
   - 缓解: 模块化设计、清晰接口、良好文档 